<!DOCTYPE html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Drag-n-Drop</title>
  <link rel="stylesheet" href="common.css" />
</head>

<style>
  .target {
    height: 30vw;
    width: 30vw;
    border: solid black 1px;
    touch-action: none;
    margin: 10% 0;
  }

  .target:nth-child(1) {
    --release-behavior: remain;
    background-color: var(--light-primary-color);
  }
  .target:nth-child(2) {
    --release-behavior: return;
    background-color: var(--default-primary-color);
  }
  .target:nth-child(3) {
    --release-behavior: complete;
    background-color: var(--dark-primary-color);
  }
</style>

<body>
  <div class="target"></div>
  <div class="target"></div>
  <div class="target"></div>
</body>
<script type="module"></script>
<script type="module">
  import { sender } from "./event-delegation.js";

  function playDnDAnimation(target) {
    const { pipe, send, delegate } = sender();
    const effect = new KeyframeEffect(
      target,
      {
        transform: ["translateX(0)", "translateX(1000px)"]
      },
      { duration: 1000 }
    );

    // can be 'remain' | 'return' | 'complete'
    const releaseBehavior = getComputedStyle(target)
      .getPropertyValue("--release-behavior")
      .trim();

    const dnd_animation = new WorkletAnimation(
      "dnd",
      effect,
      document.timeline,
      { pipe, releaseBehavior }
    );

    delegate(target, [
      "pointerdown",
      "pointermove",
      "pointerup",
      "pointerleave"
    ]);

    dnd_animation.play();
  }

  async function main() {
    console.log("Loading animation worklet...");
    await CSS.animationWorklet.addModule("dnd-animator.js");

    document
      .querySelectorAll(".target")
      .forEach(target => playDnDAnimation(target));

    // let i = 0;
    // setInterval(_ => {
    //   send( {hello: 'world'+ (i++) } )
    // }, 1000);
  }

  if (CSS.animationWorklet) {
    main();
  } else {
    if (location.hostname != "localhost" && location.protocol != "https:") {
      // redirect to https since AnimationWorklet is only available in secure contexts.
      location.href =
        "https:" +
        window.location.href.substring(window.location.protocol.length);
    } else {
      const msg =
        "Missing <tt>CSS.animationWorklet</tt>. <br> To enable demo please enable Chrome flag chrome://flags/#enable-experimental-web-platform-features and load on HTTPS";
      console.warn(msg);
      document.body.innerHTML = msg;
    }
  }
</script>